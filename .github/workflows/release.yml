name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version without v prefix (e.g., 1.0.0 or 1.0.0-beta.1)'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            TAG="v${{ inputs.version }}"
            echo "version=$TAG" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer

      - name: Install Production Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Prepare Release Directory
        env:
          PLUGIN_NAME: zw-ttvgpt
        run: |
          mkdir -p release/$PLUGIN_NAME
          rsync -av --progress . ./release/$PLUGIN_NAME \
            --include 'README.md' \
            --exclude '*.md' \
            --exclude release \
            --exclude .git \
            --exclude .github \
            --exclude .claude \
            --exclude node_modules \
            --exclude composer.json \
            --exclude composer.lock \
            --exclude package.json \
            --exclude package-lock.json \
            --exclude biome.json \
            --exclude phpcs.xml \
            --exclude phpstan.neon \
            --exclude phpstan-bootstrap.php \
            --exclude '*.log' \
            --exclude '.gitignore'

      - name: Create Zip Package
        id: package
        env:
          PLUGIN_NAME: zw-ttvgpt
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd release
          zip -r "../${PLUGIN_NAME}-${VERSION#v}.zip" $PLUGIN_NAME
          cd ..
          echo "zip_file=${PLUGIN_NAME}-${VERSION#v}.zip" >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.version.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: ${{ steps.package.outputs.zip_file }}
          generate_release_notes: true
