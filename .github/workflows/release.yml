name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            # Extract version from plugin header
            VERSION=$(sed -n 's/.*Version:\s*\([0-9a-zA-Z.-]\+\).*/\1/p' zw-ttvgpt.php | head -1)
            if [[ ! "$VERSION" =~ ^[0-9]+(\.[0-9]+)+(-(alpha|beta|rc)\.[0-9]+)?$ ]]; then
              echo "Error: Invalid version format - $VERSION"
              echo "Expected: X.Y.Z or X.Y.Z-beta.N, X.Y.Z-alpha.N, X.Y.Z-rc.N"
              exit 1
            fi
            TAG="v$VERSION"
            echo "version=$TAG" >> $GITHUB_OUTPUT
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          tools: composer

      - name: Install Production Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Prepare Release Directory
        env:
          PLUGIN_NAME: zw-ttvgpt
        run: |
          mkdir -p release/$PLUGIN_NAME
          rsync -av --progress . ./release/$PLUGIN_NAME \
            --include 'README.md' \
            --exclude '*.md' \
            --exclude release \
            --exclude .git \
            --exclude .github \
            --exclude .claude \
            --exclude node_modules \
            --exclude composer.json \
            --exclude composer.lock \
            --exclude package.json \
            --exclude package-lock.json \
            --exclude biome.json \
            --exclude phpcs.xml \
            --exclude phpstan.neon \
            --exclude phpstan-bootstrap.php \
            --exclude '*.log' \
            --exclude '.gitignore'

      - name: Create Zip Package
        id: package
        env:
          PLUGIN_NAME: zw-ttvgpt
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd release
          zip -r "../${PLUGIN_NAME}-${VERSION#v}.zip" $PLUGIN_NAME
          cd ..
          echo "zip_file=${PLUGIN_NAME}-${VERSION#v}.zip" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: ${{ steps.package.outputs.zip_file }}
          generate_release_notes: true
